# إصلاح مشكلة المحادثات في تطبيق ShamilApp

## المشكلة
تظهر جميع المحادثات باسم "محادثة" بدلاً من اسم المستخدم الآخر، ولا تظهر آخر رسالة في كل محادثة.

## الحلول المقترحة

### 1. تحليل هيكل قاعدة البيانات
لتحليل هيكل قاعدة البيانات وفهم المشكلة بشكل أفضل، قم بتشغيل السكربت التالي:
```bash
node database_structure_analyzer.js
```
هذا السكربت سيقوم بتحليل جميع ملفات SQL في مجلد SqlFile وإنشاء تقرير عن الجداول والدوال والسياسات الموجودة في قاعدة البيانات.

### 2. تحليل مشكلة المحادثات
لتحليل مشكلة المحادثات بشكل أكثر تحديدًا، قم بتشغيل السكربت التالي:
```bash
node conversation_fixer.js
```
هذا السكربت سيركز على مشكلة المحادثات وسيقوم بتحليل الدالة get_user_conversations والجداول المرتبطة بها.

### 3. تطبيق إصلاح قاعدة البيانات
لإصلاح مشكلة المحادثات في قاعدة البيانات، قم بتنفيذ الاستعلامات الموجودة في الملف:
```bash
fix_conversations.sql
```
يمكنك تنفيذ هذا الملف في واجهة Supabase SQL Editor.

## الخطوات التفصيلية

### الخطوة 1: تحليل المشكلة
1. قم بتشغيل `node database_structure_analyzer.js` للحصول على نظرة عامة على هيكل قاعدة البيانات.
2. قم بتشغيل `node conversation_fixer.js` للحصول على تحليل أكثر تحديدًا لمشكلة المحادثات.

### الخطوة 2: تطبيق الإصلاح
1. قم بتسجيل الدخول إلى لوحة تحكم Supabase.
2. انتقل إلى قسم SQL Editor.
3. انسخ محتوى ملف `fix_conversations.sql` والصقه في محرر SQL.
4. انقر على زر "Run" لتنفيذ الاستعلامات.

### الخطوة 3: التحقق من النتائج
1. قم بإعادة تشغيل التطبيق.
2. تحقق من أن المحادثات تظهر بأسماء المستخدمين الصحيحة.
3. تحقق من أن آخر رسائل تظهر في قائمة المحادثات.

## ملاحظات هامة
- تأكد من أنك نسخة احتياطية من قاعدة البيانات قبل تطبيق أي تعديلات.
- إذا كانت لديك بيانات مهمة في قاعدة البيانات، قد تحتاج إلى تعديل استعلامات الإصلاح لتجنب فقدان البيانات.
- بعد تطبيق الإصلاح، قد تحتاج إلى إعادة تشغيل التطبيق لتحديث البيانات.
